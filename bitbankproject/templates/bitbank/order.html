{% extends "bitbank/base.html" %}
{% block content %}
{% csrf_token %}
<div class="row">
    <div class="col-md-7 offset-md-1 col-12">
        <div class="tab btn-group">
            <button id="order_button" type="button" class="tablinks" onclick="openTab(event, 'order')">注文する</button>
            <button id="active_orders_button" type="button" class="tablinks" onclick="openTab(event, 'active_orders')">発注一覧</button>
            <button id="order_history_button" type="button" class="tablinks" onclick="openTab(event, 'order_history')">取引履歴</button>
            <button id="alerts_button" type="button" class="tablinks" onclick="openTab(event, 'alerts')">通知設定</button>
            <button id="assets_button" type="button" class="tablinks" onclick="openTab(event, 'assets')">保有資産</button>
            <button id="user_info_button" type="button" class="tablinks" onclick="openTab(event, 'user_info')">個人情報</button>
            <button id="contact_button" type="button" class="tablinks" onclick="openTab(event, 'contact')">問い合せ</button>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-md-6 offset-md-1 col-12">
        <div id="id_ajax_message" class="alert">
        </div>
    </div>
</div>      
        
<div id="order" class="tabcontent">
    <div class="row">
        <div class="col-md-6 offset-md-1 col-12">
            <div class="input-group">
                <div class="input-group-prepend">
                    <div class="input-group-text placeholder">取引通貨</div>
                </div>
                <select id="id_pair" class="form-control"></select>
            </div>
        </div>
    </div>
    <hr>
    <div class="row">
        <div class="col-md-6 offset-md-1 col-12">
            <div class="input-group">
                <div class="input-group-prepend">
                    <div class="input-group-text placeholder">特殊注文</div>
                </div>
                <select id="id_special_order" class="form-control"></select>
            </div>  
        </div>
    </div>

    <hr>
    <!-- 1ページ目 -->
        <div id="slider_contents">
            <div class="tabcontent-child">
                <div class="row">
                    <div class="col-md-6 offset-md-1 col-12">
                        <span class="badge badge-info">新規注文</span>
                    </div>
                </div> 
                <div class="row">
                    <div class="col-md-6 offset-md-1 col-12">
                        <div class="btn-group d-flex" role="group">
                            <button id="buy_button_1" type="button" class="btn w-100 btn-base">買い</button>
                            <button id="sell_button_1" type="button" class="btn w-100 btn-base">売り</button>
                        </div>
                    </div>
                </div>
                            
                <div class="input-group" style="display: none">
                    <select id="id_side_1" class="form-control"></select>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-6 offset-md-1 col-12">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <div class="input-group-text placeholder">注文方法</div>
                            </div>
                            <select id="id_order_type_1" class="form-control"></select>
                        </div>
                    </div>
                </div>
                <!-- <br class="show_if_stop_order_1"> -->
                <hr class="show_if_stop_order_1">
                <div class="row show_if_stop_order_1">
                    <div class="col-md-6 offset-md-1 col-12">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <div id="id_stop_price_placeholder_1" class="input-group-text placeholder">逆指値価格</div>
                            </div>
                            <input id="id_price_for_stop_1" type="number" class="form-control" min="0" step="1">              
                            <div class="input-group-append">
                                <div class="input-group-text placeholder pair">JPY</div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- <br class="show_if_limit_order_1"> -->
                <hr class="show_if_limit_order_1">
                <div class="row show_if_limit_order_1">
                    <div class="col-md-6 offset-md-1 col-12">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <div id="id_price_placeholder_1" class="input-group-text placeholder">指値価格</div>
                            </div>
                            <input id="id_price_1" type="number" class="form-control" min="0" step="1">
                            <div class="input-group-append">
                                <div class="input-group-text placeholder pair">JPY</div>
                            </div>     
                        </div>
                    </div>
                </div>
                <hr>            
                <div class="row">
                    <div class="col-md-6 offset-md-1 col-12">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                    <div class="input-group-text placeholder">数量</div>
                            </div>
                            <input id="id_start_amount_1" type="number" class="form-control" min="0" min="0" step="0.0001">  
                            <div class="input-group-append">
                                <div class="input-group-text placeholder unit">BTC</div>
                            </div>
    
                        </div>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-6 offset-md-1 col-12">
                        <input type="range" min="0" max="100" value="0" class="" id="myRange_1">
                        <div><span style="float:right;" id="amount_percentage_1">0%</span></div>
                    </div>
                </div>
                <br>
                <div class="row">
                    <div class="col-md-6 offset-md-1 col-12">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <div class="input-group-text placeholder">予想</div>
                            </div>
                            <input type="number" id="expect_price_1" class="form-control">
                            <div class="input-group-append">
                                <div class="input-group-text placeholder pair">JPY</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tabcontent-child">
                <div class="row">
                    <div class="col-md-6 offset-md-1 col-12">
                        <span class="badge badge-success"">決済注文❶</span>
                    </div>
                </div> 
                <div class="row">
                    <div class="col-md-6 offset-md-1 col-12">
                        <div class="btn-group d-flex" role="group">
                            <button id="buy_button_2" type="button" class="btn w-100 btn-base">買い</button>
                            <button id="sell_button_2" type="button" class="btn w-100 btn-base">売り</button>
                        </div>
                    </div>
                </div>
                            
                <div class="input-group" style="display: none">
                    <select id="id_side_2" class="form-control"></select>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-6 offset-md-1 col-12">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <div class="input-group-text placeholder">注文方法</div>
                            </div>
                            <select id="id_order_type_2" class="form-control"></select>
                            
                        </div>
                    </div>
                </div>
                
                <hr class="show_if_stop_order_2">
                <div class="row show_if_stop_order_2">
                    <div class="col-md-6 offset-md-1 col-12">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <div id="id_stop_price_placeholder_2" class="input-group-text placeholder">逆指値価格</div>
                            </div>
                            <input id="id_price_for_stop_2" type="number" class="form-control" min="0" step="1">              
                            <div class="input-group-append">
                                <div class="input-group-text placeholder pair">JPY</div>
                            </div> 
                        </div>
                    </div>
                </div>
                <hr class="show_if_limit_order_2">
                <div class="row show_if_limit_order_2">
                    <div class="col-md-6 offset-md-1 col-12">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <div id="id_price_placeholder_2" class="input-group-text placeholder">指値価格</div>
                            </div>
                            <input id="id_price_2" type="number" class="form-control" min="0" step="1">
                            <div class="input-group-append">
                                <div class="input-group-text placeholder pair">JPY</div>
                            </div>
                                
                        </div>
                    </div>
                </div>
            
                <hr>            
                <div class="row">
                    <div class="col-md-6 offset-md-1 col-12">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                    <div class="input-group-text placeholder">数量</div>
                            </div>
                            <input id="id_start_amount_2" type="number" class="form-control" min="0" step="0.0001">  
                            <div class="input-group-append">
                                <div class="input-group-text placeholder unit">BTC</div>
                            </div>
                        
                        </div>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-6 offset-md-1 col-12">
                        <input type="range" min="0" max="100" value="0" class="" id="myRange_2">
                        <div><span style="float:right;" id="amount_percentage_2">0%</span></div>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-6 offset-md-1 col-12">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <div class="input-group-text placeholder">予想</div>
                            </div>
                            <input type="number" id="expect_price_2" class="form-control" min="0" step="0.0001">
                            <div class="input-group-append">
                                <div class="input-group-text placeholder pair">JPY</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tabcontent-child">
                <div class="row">
                    <div class="col-md-6 offset-md-1 col-12">
                        <span class="badge badge-primary">決済注文❷</span>
                    </div>
                </div> 
                <div class="row">
                    <div class="col-md-6 offset-md-1 col-12">
                        <div class="btn-group d-flex" role="group">
                            <button id="buy_button_3" type="button" class="btn w-100 btn-base">買い</button>
                            <button id="sell_button_3" type="button" class="btn w-100 btn-base">売り</button>
                        </div>
                    </div>
                </div>
                            
                <div class="input-group" style="display: none">
                    <select id="id_side_3" class="form-control"></select>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-6 offset-md-1 col-12">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <div class="input-group-text placeholder">注文方法</div>
                            </div>
                            <select id="id_order_type_3" class="form-control"></select>
                        
                        </div>
                    </div>
                </div>
                
                <hr class="show_if_stop_order_3">
                <div class="row show_if_stop_order_3">
                    <div class="col-md-6 offset-md-1 col-12">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <div id="id_stop_price_placeholder_3" class="input-group-text placeholder">逆指値価格</div>
                            </div>
                            <input id="id_price_for_stop_3" type="number" class="form-control" min="0" step="1">              
                            <div class="input-group-append">
                                <div class="input-group-text placeholder pair">JPY</div>
                            </div>
                        </div>
                    </div>
                </div>
                <hr class="show_if_limit_order_3">
                <div class="row show_if_limit_order_3">
                    <div class="col-md-6 offset-md-1 col-12">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <div id="id_price_placeholder_3" class="input-group-text placeholder">指値価格</div>
                            </div>
                            <input id="id_price_3" type="number" class="form-control" min="0" step="1">
                            <div class="input-group-append">
                                <div class="input-group-text placeholder pair">JPY</div>
                            </div>    
                        </div>
                    </div>
                </div>
            
                <hr>            
                <div class="row">
                    <div class="col-md-6 offset-md-1 col-12">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                    <div class="input-group-text placeholder">数量</div>
                            </div>
                            <input id="id_start_amount_3" type="number" class="form-control" min="0" step="0.0001">  
                            <div class="input-group-append">
                                <div class="input-group-text placeholder unit">BTC</div>
                            </div>
                            
                        </div>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-6 offset-md-1 col-12">
                        <input type="range" min="0" max="100" value="0" class="" id="myRange_3">
                        <div><span style="float:right;" id="amount_percentage_3">0%</span></div>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-6 offset-md-1 col-12">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <div class="input-group-text placeholder">予想</div>
                            </div>
                            <input type="number" id="expect_price_3" class="form-control" min="0" step="0.0001">
                            <div class="input-group-append">
                                <div class="input-group-text placeholder pair">JPY</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    
    <hr>
    <div class="row">
        <div class="col-md-6 offset-md-1 col-12">
            <div id="id_order_result_message" class="alert">
            </div>
        </div>
    </div> 

    <div class="row">
        <div class="col-md-6 offset-md-1 col-12">
            <div class="input-group">
                <button id="id_order_button" type="button" class="btn btn-lg btn-block green_button">注文</button>
            </div>  
        </div>
    </div>
</div>
<div id="active_orders" class="tabcontent">
    <div class="row">
        <div class="col-md-6 offset-md-1 col-12">
            <div class="input-group">
                <div class="input-group-prepend">
                    <div class="input-group-text placeholder">検索通貨</div>
                </div>
                <select id="id_active_orders_search_pair" class="form-control"></select>
            </div>
        </div>
    </div>
    <hr>
    <div id="active_orders_content"></div>
    <div class="row">
        <div id="page_selection_active_orders" class="col-md-6 offset-md-1 col-12">

        </div>
    </div>
</div>  
<div id="order_history" class="tabcontent">
    <div class="row">
        <div class="col-md-6 offset-md-1 col-12">
            <div class="input-group">
                <div class="input-group-prepend">
                    <div class="input-group-text placeholder">検索通貨</div>
                </div>
                <select id="id_order_history_search_pair" class="form-control"></select>
            </div>
        </div>
    </div>
    <hr>
    <div id="order_history_content"></div>
    <div class="row">
        <div id="page_selection_order_history" class="col-md-6 offset-md-1 col-12">

        </div>
    </div>

</div>
<div id="assets" class="tabcontent">
    <div class="row">
        <div class="col-md-6 offset-md-1 col-xs12">
            <div class="table-responsive">
                <table id="asset_table" class="table table-sm table-dark">
                    <tr><th>合計評価額</th><td align="right" id="total_in_jpy"></td></tr>
                    <tr><th>日本円</th><td align="right" id="jpy"></td></tr>
                    <tr><th>ビットコイン</th><td align="right" id="btc"></td></tr>
                    <tr><th>リップル</th><td align="right" id="xrp"></td></tr>
                    <tr><th>ライトコイン</th><td align="right" id="ltc"></td></tr>
                    <tr><th>イーサリアム</th><td align="right" id="eth"></td></tr>
                    <tr><th>モナーコイン</th><td align="right" id="mona"></td></tr>
                    <tr><th>ビットコインキャッシュ</th><td align="right" id="bcc"></td></tr>
                </table>
            </div>
        </div>
    </div>
</div>
<div id="alerts" class="tabcontent">
    <div class="row">
        <div class="col-md-6 offset-md-1 col-xs-8">
            <label class="control-label">約定通知</label>
            <div class="btn-group d-flex" role="group">
                <button id="notify_if_filled_off_button" type="button" class="btn w-100 btn-base">OFF</button>
                <button id="notify_if_filled_on_button" type="button" class="btn w-100 btn-base">ON</button>      
            </div>
        </div>  
    </div>
    <hr>
    <div class="row">
        <div class="col-md-6 offset-md-1">
            <div class="input-group">
                <div class="input-group-prepend">
                    <select class="form-control" id="id_pair_for_alert" style="padding-right: 1.5em !important;">
                    </select>
                </div>
                <input type="number" id="id_notice_rate" class="form-control" min="0">
                <div class="input-group-append">
                    <div class="input-group-text placeholder pair_for_alert">JPY</div>
                </div>
                <div class="input-group-append">
                    <button id="add_alert_button" class="btn green_button" type="button">追加</button>
                </div>
            </div>
        </div>
    </div>
    <hr>
    <div class="row">
        <div class="col-md-6 offset-md-1 col-12">
            <div class="input-group">
                <div class="input-group-prepend">
                    <div class="input-group-text placeholder">検索通貨</div>
                </div>
                <select id="id_alerts_search_pair" class="form-control"></select>
            </div>
        </div>
    </div>
    <hr>
    <div id="alert_container">
        
    </div> 
    <div class="row">
        <div id="page_selection_alerts" class="col-md-6 offset-md-1 col-12">

        </div>
    </div>
</div>
<div id="user_info" class="tabcontent">
    <div class="row">
        <div class="col-md-6 offset-md-1 col-12">
            <div class="table-responsive">
                <table class="table table-dark">
                    <tbody>
                        <tr>
                            <th>登録日</th>
                            <td id="id_date_joined"></td>
                        </tr>
                        <tr>
                            <th>名前</th>
                            <td><input id="id_full_name" type="text" class="form-control"></td>
                        </tr>
                        <tr>
                            <th>登録メールアドレス</th>
                            <td id="id_email" ></td>
                        </tr>

                        <tr>
                            <th>API KEY</th>
                            <td><input id="id_api_key" type="text" class="form-control"></td>
                        </tr>
                        <tr>
                            <th>API SECRET KEY</th>
                            <td><input id="id_api_secret_key" type="text" class="form-control"></td>
                        </tr>
                        <tr>
                            <th>通知用メールアドレス</th>
                            <td><input id="id_email_for_notice" type="email" class="form-control"></td>
                        </tr>
                    </tbody>
                </table> 
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-6 offset-md-1 col-12">
            パスワード変更は<a href="{% url 'bitbank:password_change' %}">こちら</a>
        </div>
    </div>
    <hr>
    <div class="row">
        <div class="col-md-2 offset-md-1 col-6">
            <button id="id_update_user_info_button" type="button" class="btn btn-block green_button">更新</button>
            
        </div>
        <div class="col-md-2 col-6">
            <a href="{% url 'bitbank:logout'%}" class="btn btn-block red_button">ログアウト</a>
        </div>
    </div>
</div>  
<div id="contact" class="tabcontent">
  <div class="row">
    <div class="col-md-6 offset-md-1 col-12">
        <div class="table-responsive">
            <table class="table table-dark">
                <tbody>
                    <tr>
                        <th>問い合わせ日時</th>
                        <td><input id="id_contact_date" disabled type="text" class="form-control" value="2019/02/11"></td>
                    </tr>
                    <tr>
                        <th>名前</th>
                        <td><input id="id_contact_name" type="text" class="form-control"></td>
                    </tr>
                    <tr>
                        <th>メールアドレス</th>
                        <td><input id="id_contact_email" type="text" class="form-control"></td>
                    </tr>

                    <tr>
                        <th>件名</th>
                        <td><input id="id_contact_subject" type="text" class="form-control"></td>
                    </tr>
                    <tr>
                        <th>内容</th>
                        <td><textarea id="id_contact_body" class="form-control"></textarea></td>
                    </tr>
                    <tr>
                        <th>添付ファイル<br>(3つまで)</th>
                        <td>
                    
                        <button type="button" class="btn btn-primary js-upload-file">
                            <span class="glyphicon glyphicon-cloud-upload"></span>ファイルを選択
                        </button>
                        
                         <!-- {# 2. FILE INPUT TO BE USED BY THE PLUG-IN #} -->
                        <input id="fileupload" type="file" name="attachments[]" multiple style="display: none"
                                data-url="{% url 'bitbank:ajax_post_inquiry' %}"
                                data-form-data='{"csrfmiddlewaretoken": "{{ csrf_token }}"}'>
                        <div id="id_attachment_preview"></div>
                        </td>
                    </tr>
                </tbody>
            </table> 
        </div>
    </div>
</div>   
<div class="row">
    <div class="col-md-6 offset-md-1 col-12">
        <div id="id_contact_message" class="alert"></div>
    </div>
</div> 
<div class="row">
    <div class="col-md-2 offset-md-1 col-6">
        <button id="id_contact_send_inquiry_button" type="button" class="btn btn-block green_button">送信</button>
    </div>
</div>
</div>

{% endblock %}
{% block extra_js %}
    <script>
        COOKIE_ORDER_PAIR = "ck_order_pair";
        COOKIE_ORDER_TYPE = "ck_order_type";
        COOKIE_ORDER_SIDE = "ck_order_side";
        COOKIE_SPECIAL_ORDER = "ck_special_order";
        
        COOKIE_ALERT_PAIR = "ck_alert_pair";
        COOKIE_SEARCH_PAIR_ALERTS = "ck_search_pair_alerts";
        COOKIE_SEARCH_PAIR_ACTIVE_ORDERS = "ck_search_pair_ao";
        COOKIE_SEARCH_PAIR_ORDER_HISTORY = "ck_search_pair_oh";

        COOKIE_LAST_VISITED_TAB = "ck_last_visited_tab";
        PAIRS = {
            'btc_jpy': 'BTC/JPY',
            'xrp_jpy': 'XRP/JPY',
            'ltc_btc': 'LTC/BTC',
            'eth_btc': 'ETH/BTC',
            'mona_jpy': 'MONA/JPY',
            'mona_btc': 'MONA/BTC',
            'bcc_jpy': 'BCC/JPY',
            'bcc_btc': 'BCC/BTC'
        }

        STATUS = {
            'UNFILLED': '未約定',
            'PARTIALLY_FILLED': '一部約定済',
            'FULLY_FILLED': '約定済',
            'CANCELED_UNFILLED': 'キャンセル済',
            'CANCELED_PARTIALLY_FILLED': '一部キャンセル済',
            'READY_TO_ORDER': '未注文',
            'FAILED_TO_ORDER': '注文失敗'
        }
        SPECIAL_ORDERS = [
            'SINGLE',
            'IFD',
            'OCO',
            'IFDOCO'  
        ];

        ORDER_TYPES = {
            'market': '成行',
            'limit': '指値',
            'stop_market': '逆指値',
            'stop_limit': 'ストップリミット'
        };
        var count_per_page = 10;
        
        SELL_BUY = {
            'sell': '売',
            'buy' : '買'
        }
        function isNumberKey(evt){
            var charCode = (evt.which) ? evt.which : event.keyCode;
            return !(charCode > 31 && (charCode < 48 || charCode > 57));
        }

        //資産情報取得用
        var free_amount_json = {};

        var market_price_json = {};

        function return_formatted_datetime(unixtime, date_only=false) {
            if (unixtime == 0) {
                return '-';
            }
            var date = new Date(unixtime);
            var year = date.getFullYear();
            var month = date.getMonth() + 1 < 10 ? '0' + (date.getMonth() + 1):date.getMonth() + 1 ;
            var day = date.getDate() < 10 ? '0' + date.getDate():date.getDate();
            var hours = date.getHours() < 10 ? '0' + date.getHours():date.getHours();
            var minutes = date.getMinutes() < 10 ? '0' + date.getMinutes():date.getMinutes();
            var seconds = date.getSeconds() < 10 ? '0' + date.getSeconds():date.getSeconds();
            if (date_only) {
                return(year + "/" + month + "/" + day);
            }
            return(year + "/" + month + "/" + day + " " + hours + ":" + minutes + ":" + seconds);
        }
        
        
        function call_get_assets_api(is_async = true) {
            return $.ajax({
                'url': '{% url "bitbank:ajax_get_assets" %}',
                'type': 'GET',
                'dataType': 'json',
                'async': is_async
            });
        }
        function call_get_ticker_api(pair, is_async = true) {
            return $.ajax({
                'url': '{% url "bitbank:ajax_get_ticker" %}',
                'type': 'GET',
                'dataType': 'json',
                'async': is_async,
                'data': {
                    'pair': pair
                },
            });
        }
        function call_cancel_order(pk) {
            return $.ajax({
                'url': '{% url "bitbank:ajax_cancel_order" %}',
                'type': 'POST',
                'dataType': 'json',
                'data': {
                    pk: pk
                }
            });
        }
        function call_get_user() {
            return $.ajax({
                'url': '{% url "bitbank:ajax_get_user" %}',
                'type': 'GET',
                'dataType': 'json'
            });
        }
        function call_update_user(full_name, api_key, api_secret_key, email_for_notice) {
            return $.ajax({
                'url': '{% url "bitbank:ajax_update_user" %}',
                'type': 'POST',
                'dataType': 'json',
                'data': {
                    full_name: full_name,
                    api_key: api_key,
                    api_secret_key: api_secret_key,
                    email_for_notice: email_for_notice
                }
            });
        }
        function call_get_active_orders(offset, limit, search_pair) {
            return $.ajax({
                'url': '{% url "bitbank:ajax_get_active_orders" %}',
                'type': 'GET',
                'dataType': 'json',
                'data': {
                    'offset': offset,
                    'limit': limit,
                    'search_pair': search_pair
                }
            });
        }
        function call_get_order_history(offset, limit, search_pair) {
            return $.ajax({
                'url': '{% url "bitbank:ajax_get_order_history" %}',
                'type': 'GET',
                'dataType': 'json',
                'data': {
                    'offset': offset,
                    'limit': limit,
                    'search_pair': search_pair
                }
            });
            
        }
      
        function call_create_order(pair, special_order, side, order_type, price = null, price_for_stop = null, start_amount) {
            return $.ajax({
                'url': '{% url "bitbank:ajax_create_order" %}',
                'type': 'POST',
                'dataType': 'json',
                'data': {
                    pair: pair,
                    special_order: special_order,
                    side: side,
                    order_type: order_type,
                    price: price,
                    price_for_stop: price_for_stop,
                    start_amount: start_amount
                }
            });
        }

        function call_create_alert(pair, threshold, over_or_under) {
            return $.ajax({
                'url': '{% url "bitbank:ajax_create_alert" %}',
                'type': 'POST',
                'dataType': 'json',
                'data': {
                    pair: pair,
                    threshold: threshold,
                    over_or_under: over_or_under
                }
            });
        }

        function call_deactivate_alert(pk) {
            return $.ajax({
                'url': '{% url "bitbank:ajax_deactivate_alert" %}',
                'type': 'POST',
                'dataType': 'json',
                'data': {
                    pk: pk
                }
            });
        }

        function call_get_active_alerts(offset, limit, search_pair) {
            return $.ajax({
                'url': '{% url "bitbank:ajax_get_active_alerts" %}',
                'type': 'GET',
                'dataType': 'json',
                'data': {
                    'offset': offset,
                    'limit': limit,
                    'search_pair': search_pair
                }
            });
        }
        function call_get_notify_if_filled() {
            return $.ajax({
                'url': '{% url "bitbank:ajax_get_notify_if_filled" %}',
                'type': 'GET',
                'dataType': 'json'
            });
        }
        function call_change_notify_if_filled(new_val) {
            return $.ajax({
                'url': '{% url "bitbank:ajax_change_notify_if_filled" %}',
                'type': 'POST',
                'dataType': 'json',
                'data': {
                    notify_if_filled: new_val
                }
            });
        }
        function call_post_inquiry_without_files(subject, body, email_for_reply) {
            return $.ajax({
                'url': '{% url "bitbank:ajax_post_inquiry" %}',
                'type': 'POST',
                'dataType': 'json',
                'data': {
                    subject: subject,
                    body: body,
                    email_for_reply: email_for_reply,
                }
            })
        }

        function hyphen_if_null(subj) {
            if (subj == null || subj == undefined || subj == '0') {
                return '-';
            } else {
                return subj;
            }
        }
        function display_price_div(tab_num, order_type) {
            switch (order_type) {
                case 'market':
                    $('.show_if_stop_order_' + tab_num).hide();
                    $('.show_if_limit_order_' + tab_num).hide();
                    break;
                case 'limit':
                    $('.show_if_stop_order_' + tab_num).hide();
                    $('.show_if_limit_order_' + tab_num).show();
                    break;
                case 'stop_market':
                    $('.show_if_stop_order_' + tab_num).show();
                    $('.show_if_limit_order_' + tab_num).hide();
                    break;
                case 'stop_limit':
                    $('.show_if_stop_order_' + tab_num).show();
                    $('.show_if_limit_order_' + tab_num).show();
                    break;
            }
        }

        function initialize_ticker_json() {
            Object.keys(PAIRS).forEach(pair => {
                call_get_ticker_api(pair)
                .done(function (res) {
                    if (res.error) {
                        set_error_message($('#id_ajax_message'),200 , res.error);
                        return;
                    }
                    //console.log(res);
                    market_price_json[pair] = res;              
                })
                .fail(function(data, textStatus, xhr) {
                    if (data.status == 401) {
                        window.location.href = "{% url 'bitbank:login' %}";
                    }
                    set_error_message($('#id_ajax_message'), xhr);
                });
            });
        }
        function initialize_free_amount_json() {
            call_get_assets_api()
            .done(function(res) {
                if (res.error) {
                    set_error_message($('#id_ajax_message'), res.error);
                    return;
                }
                res.assets.forEach(asset => {
                    free_amount_json[asset.asset] = asset.free_amount;
                });
            })
            .fail(function(data, textStatus, xhr) {
                if (data.status == 401) {
                    window.location.href = "{% url 'bitbank:login' %}";
                }
                set_error_message($('#id_ajax_message'), xhr);
            });
        }
        function update_amount_by_slider(tab_num) {
            var newVal = $('#myRange_' + tab_num).val();
            
            $('#amount_percentage_' + tab_num).html(newVal + '%');
            
            if($('#id_pair').val() == '') {
                return;
            }
            
            var pair = $('#id_pair').val();
            var side = $('#id_side_' + tab_num).val();
            var order_type = $('#id_order_type_' + tab_num).val();
            var currency = (side == 'sell') ? pair.split('_')[0] : pair.split('_')[1];
            if (parseInt(newVal) != 0) {
                var free_amount = free_amount_json[currency];
                var price = (order_type.match(/market/)) ? parseFloat(market_price_json[pair][side]) : ($('#id_price').val() != '') ? parseFloat($('#id_price').val()) : 0;
                var floored = (side == 'sell') ? Math.floor((free_amount * newVal / 100) * 10000) / 10000 : (price != 0) ? Math.floor((free_amount * newVal / (price * 100)) * 10000) / 10000 : 0;
                $('#id_start_amount_' + tab_num).val(floored).trigger('calculate');
            } else {
                $('#id_start_amount_' + tab_num).val(0).trigger('calculate');
            }
            
        }
        function update_slider_by_amount(tab_num) {
            var pair = $('#id_pair').val();
            var side = $('#id_side_' + tab_num).val(); 

            if (side == 'buy') {
                var currency = pair.split('_')[1];
            } else {
                var currency = pair.split('_')[0];
            }
            
            
            var order_type = $('#id_order_type_' + tab_num).val();
            
            var new_amount = $('#id_start_amount_' + tab_num).val();

            // limit orderの場合
            if (order_type.match(/limit/)) {
                var new_price = $('#id_price_' + tab_num).val();
            } else {
                var new_price = market_price_json[pair][side];
            }

            if (new_amount == '' || new_amount == 0 || new_price == '' || new_price == 0) {
                set_slidevalue(tab_num, 0);
            } else {
                if (side == 'buy') {
                    var perc = new_price * new_amount * 100 / parseFloat(free_amount_json[currency]);
                } else {
                    var perc = new_amount * 100 / parseFloat(free_amount_json[currency]);   
                }
                
                if (perc > 100.0) {
                    $('#amount_percentage_' + tab_num).html('資金不足');
                } else {
                    var rounded = Math.round(perc * 10) / 10;
                    set_slidevalue(tab_num, rounded, false);
                    if (currency == 'jpy') {
                        $('#expect_price_' + tab_num).val(Math.round(new_price * new_amount));
                    } else {
                        $('#expect_price_' + tab_num).val(Math.round(new_price * new_amount * 10000) / 10000);
                    } 
                }
            }
        }
        function calculate_expect_price(tab_num) {
            var pair = $('#id_pair').val();
            var side = $('#id_side_' + tab_num).val();
            var order_type = $('#id_order_type_' + tab_num).val();
            var amount = $('#id_start_amount_' + tab_num).val();

            if (parseFloat(amount) == 0 || amount == '') {
                $('#expect_price_' + tab_num).val(0);
            } else {
                var price = (order_type.match(/market/)) ? parseFloat(market_price_json[pair][side]) : ($('#id_price_' + tab_num).val() != '') ? parseFloat($('#id_price_' + tab_num).val()) : 0;
                if (pair.split('_')[1] == 'jpy') {
                    $('#expect_price_' + tab_num).val(Math.floor(price * amount));    
                } else {
                    $('#expect_price_' + tab_num).val(price * amount);    
                }
            }
        }
        function place_single_order(pair, special_order, side, order_type, price, price_for_stop, start_amount, message_target) {
            call_create_order(pair, special_order, side, order_type, price, price_for_stop, start_amount)
            .done(function(res) {
                if (res.error) {
                    set_error_message(message_target, res.error);
                    return;
                }
                set_success_message(message_target, '注文が完了しました');
            })
            .fail(function(data, textStatus, xhr) {
                if (data.status == 401) {
                    window.location.href = "{% url 'bitbank:login' %}";
                }
                set_error_message(message_target, xhr);
            });
        }
        function set_slidevalue(tab_num, new_val, trigger_input_event=true) {
            var tar = $('#myRange_' + tab_num);
            if (trigger_input_event) {
                tar.val(new_val).trigger('input');
            } else {
                tar.val(new_val);
            }
            
            var ini = (tar.val() - tar.attr('min')) / (tar.attr('max') - tar.attr('min'));
            tar.css('background-image',
                    '-webkit-gradient(linear, left top, right top, '
                    + 'color-stop(' + ini + ', ' + ($('#id_side_' + tab_num).val() == 'buy' ? 'teal' : 'orangered') + '), '
                    + 'color-stop(' + ini + ', #333333)'
                    + ')'
            );
            $('#amount_percentage_' + tab_num).html(new_val + '%');
        }

        function initialize_order_tab(is_initial = false) {
            var order_result_message_target = $('#id_order_result_message');
            var ajax_message_target = $('#id_ajax_message');
            initialize_ticker_json();
            initialize_free_amount_json();

            for (let i = 1; i < 4; i ++) {
                if ($('#id_side_' + i).val() == 'sell') {
                    $('#sell_button_' + i).addClass('sell').removeClass('btn-base');
                    $('#buy_button_' + i).removeClass('buy').addClass('btn-base');
                } else {
                    $('#buy_button_' + i).addClass('buy').removeClass('btn-base');
                    $('#sell_button_' + i).removeClass('sell').addClass('btn-base');
                }
            }
            

            //画面ロード時のみ
            if (is_initial) {
                var input_pair = $('#id_pair');
                var input_special_order = $('#id_special_order');
                var button_order = $('#id_order_button');
                var input_number = $('input[type="number"]');

                var pair_option_html = '';
                var special_order_option_html = '';
                var side_option_html = '';
                var order_type_option_html = '';
                $('#slider_contents')
                .slick({
                    swipe: false,
                    touchMove: false,
                    prevArrow: false,
                    nextArrow: false,
                    dots: true,
                });
                
                Object.keys(PAIRS).forEach(pair => {
                    pair_option_html += '<option value="' + pair + '">' + PAIRS[pair] + '</option>';
                });

                SPECIAL_ORDERS.forEach(special_order => {
                    if (special_order == 'SINGLE') {
                        special_order_option_html += '<option value="' + special_order + '">' + special_order + '</option>';
                    } else {
                        special_order_option_html += '<option value="' + special_order + '">' + special_order + '</option>';
                    }
                    
                });

                Object.keys(SELL_BUY).forEach(side => {
                    side_option_html += '<option value="' + side + '">' + side + '</option>';
                });

                Object.keys(ORDER_TYPES).forEach(order_type => {
                    order_type_option_html += '<option value="' + order_type + '">' + ORDER_TYPES[order_type] + '</option>';
                });
                
                input_special_order
                .on('change', function() {
                    $('#slider_contents')
                    .slick('slickUnfilter')
                    .slick('slickFilter', function(index){
                        switch ($('#id_special_order').val()) {
                            case 'SINGLE':
                                if (index == 0){
                                    return $(this).eq(index);  
                                }
                                break;
                            case 'IFD':
                                if (index < 2){
                                    return $(this).eq(index);  // スライド番号が2より小さいものだけ表示
                                }
                                break;
                            case 'OCO':
                                if (index > 0){
                                    return $(this).eq(index);  // スライド番号が2より小さいものだけ表示
                                }
                                break;
                            case 'IFDOCO':
                                return $(this).eq(index);  // スライド番号が2より小さいものだけ表示
                                break;
                        }   
                    });
                });

                input_number
                .on('keydown', function(e) {
                
                    if(!((e.keyCode > 95 && e.keyCode < 106)
                    || (e.keyCode > 47 && e.keyCode < 58) 
                    || e.keyCode == 8 || e.keyCode == 190)) {
                        return false;
                    }
                });

                input_pair.on('change', function() {
                    $.cookie(COOKIE_ORDER_PAIR, $(this).val(), { expires: 7 });

                    input_number.val('');
                    for (let i = 1; i< 4; i++) {
                        set_slidevalue(i, 0);
                    }

                    // 数量、金額の通貨部分を更新
                    var unit = $(this).val().split('_')[0].toUpperCase();
                    var currency = $(this).val().split('_')[1].toUpperCase();
                    if (currency != '') {
                        $('div.pair').html(currency);
                        $('div.unit').html(unit);
                    }

                    // 一覧タブを更新
                    $('.tablinks.active').click();
                });
                
                // 選択肢追加
                input_pair.html(pair_option_html);
                // クッキーにあればデフォルトセット
                var ck_pair = $.cookie(COOKIE_ORDER_PAIR);
                if (ck_pair != undefined && Object.keys(PAIRS).indexOf(ck_pair) >= 0) {
                    input_pair.val(ck_pair).trigger('change');
                } else {
                    // 無ければ先頭の選択肢をセット
                    input_pair.val(Object.keys(PAIRS)[0]);
                }

                input_special_order.html(special_order_option_html);
  
                    
                for (let i = 1; i < 4; i++) {

                    $('#myRange_' + i).on("input", function () {
                        update_amount_by_slider(i);
                        var val = ($(this).val() - $(this).attr('min')) / ($(this).attr('max') - $(this).attr('min'));
                        //alert($('#id_side_' + i).val() == 'buy' ? 'teal' : 'orangered');
                        $(this).css('background-image',
                            '-webkit-gradient(linear, left top, right top, '
                            + 'color-stop(' + val + ', ' + ($('#id_side_' + i).val() == 'buy' ? 'teal' : 'orangered') + '),'
                            + 'color-stop(' + val + ', #333333)'
                            + ')'
                        );
                    });
        
                    $('#id_start_amount_' + i)
                    .on('change', function() {
                        update_slider_by_amount(i);
                    })
                    .on('calculate', function() {
                        calculate_expect_price(i);
                    });

                    $('#id_price_' + i)
                    .on('change', function() {
                 
                        update_slider_by_amount(i);
                    });
 
                    $('#id_order_type_' + i).on('change', function() {
                        $('#id_price_' + i).val(0);
                        $('#id_price_for_stop_' + i).val(0);
                        set_slidevalue(i, 0);
                        var new_order_type = $(this).val();
                        $.cookie(COOKIE_ORDER_TYPE + '_' + i, new_order_type, { expires: 7 });
                        if (new_order_type == 'limit') {
                            $('#id_price_placeholder_' + i).html('指値価格');
                        } else if (new_order_type == 'stop_market') {
                            $('#id_stop_price_placeholder_' + i).html('逆指値価格');
                        } else if (new_order_type == 'stop_limit') {
                            $('#id_stop_price_placeholder_' + i).html('逆指値(発動価格)');
                            $('#id_price_placeholder_' + i).html('指値(約定希望価格)');
                        }

                        if (new_order_type.match(/limit/)) {
                        
                            call_get_ticker_api(input_pair.val())
                            .done(function(res) {
                                if (res.error) {
                                    set_error_message(ajax_message_target, res.error);
                                    return;
                                }
                                $('#id_price_' + i).val(res.last);
                                $('#id_price_for_stop_' + i).val(res.last);
                            })
                            .fail(function(data, textStatus, xhr) {
                                if (data.status == 401) {
                                    window.location.href = "{% url 'bitbank:login' %}";
                                }
                                set_error_message(ajax_message_target, xhr);
                            });
                        }
                        
                        display_price_div(i, new_order_type);
                    });
                    $('#id_side_' + i).on('value_change', function() {
                        
                        set_slidevalue(i, 0);
                        if ($(this).val() == 'buy') {
                            
                            $('#sell_button_' + i).removeClass('sell').addClass('btn-base');
                            $('#buy_button_' + i).addClass('buy').removeClass('btn-base');
                            $('#myRange_' + i).addClass('slider_for_buy').removeClass('slider_for_sell');
                            button_order.addClass('green_button').removeClass('red_button');
                        } else {
                           
                            $('#sell_button_' + i).addClass('sell').removeClass('btn-base');
                            $('#buy_button_' + i).removeClass('buy').addClass('btn-base');
                            $('#myRange_' + i).addClass('slider_for_sell').removeClass('slider_for_buy');
                            button_order.removeClass('green_button').addClass('red_button');
                        }
                    });
                    $('#sell_button_' + i).on('click', function() {
                        // 変更があった場合のみ処理
                        if ($('#id_side_' + i).val() == 'buy') {
                            $.cookie(COOKIE_ORDER_SIDE + '_' + i, 'sell', {expire: 7});
                            $(this).addClass('sell').removeClass('btn-base');
                            $('#buy_button_' + i).removeClass('buy').addClass('btn-base');
                            $('#id_side_' + i).val('sell').trigger('value_change');
                            button_order.removeClass('green_button').addClass('red_button'); 
                        } else {
                            // do nothing
                           
                        }
                        
                    });
                    $('#buy_button_' + i).on('click', function() {
                        // 変更があった場合のみ処理
                        if ($('#id_side_' + i).val() == 'sell') {
                            $.cookie(COOKIE_ORDER_SIDE + '_' + i, 'buy', {expire: 7});
                            $(this).addClass('buy').removeClass('btn-base');
                            $('#sell_button_' + i).removeClass('sell').addClass('btn-base');
                           

                            $('#id_side_' + i).val('buy').trigger('value_change');
                            button_order.removeClass('red_button').addClass('green_button');
                        } else {
                           
                        }
                    });
                    


  
                    $('#id_side_' + i).html(side_option_html);
                    var ck_order_side = $.cookie(COOKIE_ORDER_SIDE + '_' + i);
                    if (ck_order_side != undefined && Object.keys(SELL_BUY).indexOf(ck_order_side) >= 0) {
                        $('#id_side_' + i).val(ck_order_side).trigger('value_change');
                    
                    } else {
                        $('#id_side_' + i).val(Object.keys(SELL_BUY)[1]).trigger('value_change');
                    }

                    $('#id_order_type_' + i).html(order_type_option_html);
                    var ck_order_type = $.cookie(COOKIE_ORDER_TYPE + '_' + i);
                    if (ck_order_type != undefined && Object.keys(ORDER_TYPES).indexOf(ck_order_type) >= 0) {
                        $('#id_order_type_' + i).val(ck_order_type);
                        if (ck_order_type == 'limit') {
                            $('#id_price_placeholder_' + i).html('指値価格');
                        } else if (ck_order_type == 'stop_market') {
                            $('#id_stop_price_placeholder_' + i).html('逆指値価格');
                        } else if (ck_order_type == 'stop_limit') {
                            $('#id_stop_price_placeholder_' + i).html('逆指値(発動価格)');
                            $('#id_price_placeholder_' + i).html('指値(約定希望価格)');
                        }
                    } else {
                        $('#id_order_type_' + i).val(Object.keys(ORDER_TYPES)[0]);
                    }
                    set_slidevalue(i, 0);
                    display_price_div(i, $('#id_order_type_' + i).val());
                }
                
                var ck_special_order = $.cookie(COOKIE_SPECIAL_ORDER);
                if (ck_special_order != undefined && SPECIAL_ORDERS.indexOf(ck_special_order) >= 0) {
                    input_special_order.val(ck_special_order).trigger('change');
                } else {
                    input_special_order.val(SPECIAL_ORDERS[0]).trigger('change');
                }

                button_order.on('click', function(e) {
                    switch (input_special_order.val()) {
                        case 'SINGLE':
                            var pair = input_pair.val();
                            var special_order = input_special_order.val();
                            var side = $('#id_side_1').val();
                            var order_type = $('#id_order_type_1').val();
                            var price = $('#id_price_1').val() == '' ? null : parseFloat($('#id_price_1').val());
                            var price_for_stop = $('#id_price_for_stop_1').val() == '' ? null : parseFloat($('#id_price_for_stop_1').val());
                            var start_amount = $('#id_start_amount_1').val();
                            if (order_type.match(/limit/)) {
                                call_get_ticker_api(pair)
                                .done(function(res) {
                                    if (res.error) {
                                        set_error_message(ajax_message_target, res.error);
                                        return;
                                    }
                                        
                                    if (order_type == 'limit') {
                                        if ((side == 'buy' && parseFloat(res.buy) < price) || (side == 'sell' && parseFloat(res.sell) > price)){
                                            $.confirm({
                                                title: '<span style="color:black>確認</span>',
                                                content: '<span style="color:black">注文確定後すぐに約定しますがこの価格でよろしいですか？</span>',
                                                type: 'red',
                                                buttons: {
                                                    confirm: {
                                                        text: 'はい',
                                                        btnClass: 'green_button',
                                                        
                                                        action: function () {
                                                            place_single_order(pair, special_order, side, order_type, price, price_for_stop, start_amount);
                                                        }
                                                    },
                                                    cancel:{
                                                        text: 'いいえ',
                                                        btnClass: 'red_button',
                                                        action: function () {
                                                        },
                                                    }
                                                }
                                            });
                                        } else {
                                            place_single_order(pair, special_order, side, order_type, price, price_for_stop, start_amount, order_result_message_target);
                                        }
                                        
                                    } else if (order_type == 'stop_limit') {
                                        place_single_order(pair, special_order, side, order_type, price, price_for_stop, start_amount, order_result_message_target);
                                    }
                                })
                                .fail(function(data, textStatus, xhr) {
                             
                                    if (data.status == 401) {
                                        window.location.href = "{% url 'bitbank:login' %}";
                                    }
                                    set_error_message(ajax_message_target, xhr);
                                });
                            } else if (order_type.match(/market/)) {
                                // そのまま注文
                                place_single_order(pair, special_order, side, order_type, price, price_for_stop, start_amount, order_result_message_target);
                            }
                            break;
                        case 'IFD':
                            break;
                        case 'OCO':
                            break;
                        case 'IFDOCO':
                            break;
                    }
                });  
            }
        }
        
        function initialize_active_orders_content(message_target) {
            var page_selection = $('#page_selection_active_orders');
            var search_pair = $('#id_active_orders_search_pair').val();
            call_get_active_orders(0, 1, search_pair)
            .done(function(res_1) {
                if (res_1.error) {
                    set_error_message(message_target, res_1.error);
                    return;
                }
                if(page_selection.data("twbs-pagination")){
                    page_selection.empty();
                    page_selection.removeData("twbs-pagination");
                    page_selection.unbind("page");
                }
                page_selection.twbsPagination({
                    totalPages: (res_1.total_count == 0) ? 1 : Math.ceil(res_1.total_count / count_per_page),
                    next: '次',
                    prev: '前',
                    first: '先頭',
                    last: '最後',
                    onPageClick: function (event, page) {
                        var table_html = '';
                        call_get_active_orders(count_per_page * (page - 1), count_per_page, search_pair)
                        .done(function(res_2) {
                            if (res_2.error) {
                                set_error_message(message_target, res_2.error);
                                return;
                            }
                            console.log(res_2);
                            var table_html = "";
                            $.parseJSON(res_2.active_orders).forEach(active_order => {
                                //table_html += '<div class="">'
                                table_html += '<div class="row"><div class="col-md-6 offset-md-1 col-12"><div class="card order-card"><div class="card-body"><div class="row">';
                                table_html += '<div class="col-3 card-table-header">注文ID</div>';
                                table_html += '<div class="col-3 card-table-data">' + hyphen_if_null(active_order.fields.order_id) + '</div>';
                                table_html += '<div class="col-3 card-table-header">取引通貨</div>';
                                table_html += '<div class="col-3 card-table-data">' + PAIRS[active_order.fields.pair] + '</div>';
                                table_html += '</div>';
                                table_html += '<div class="row">';
                                table_html += '<div class="col-3 card-table-header">タイプ</div>';
                                table_html += '<div class="col-3 card-table-data">' + ORDER_TYPES[active_order.fields.order_type] + '</div>';
                                table_html += '<div class="col-3 card-table-header">売/買</div>';
                                table_html += '<div class="col-3 card-table-data">' + SELL_BUY[active_order.fields.side] + '</div>';
                                table_html += '</div>';
                                table_html += '<div class="row">';
                                table_html += '<div class="col-3 card-table-header">数量</div>';
                                table_html += '<div class="col-3 card-table-data">' + active_order.fields.start_amount + '</div>';
                                table_html += '<div class="col-3 card-table-header">逆指値価格</div>';
                                table_html += '<div class="col-3 card-table-data">' + hyphen_if_null(active_order.fields.price_for_stop) + '</div>';
                                table_html += '</div>';
                                table_html += '<div class="row">';
                                table_html += '<div class="col-3 card-table-header">約定数量</div>';
                                table_html += '<div class="col-3 card-table-data">' + hyphen_if_null(active_order.fields.executed_amount) + '</div>';
                                table_html += '<div class="col-3 card-table-header">指値価格</div>';
                                table_html += '<div class="col-3 card-table-data">' + hyphen_if_null(active_order.fields.price) + '</div>';
                                table_html += '</div>';
                                table_html += '<div class="row">';
                                table_html += '<div class="col-3 card-table-header"></div>';
                                table_html += '<div class="col-3 card-table-data"></div>';
                                table_html += '<div class="col-3 card-table-header">平均価格</div>';
                                table_html += '<div class="col-3 card-table-data">' + hyphen_if_null(active_order.fields.average_price) + '</div>';
                                table_html += '</div>';
                                table_html += '<div class="row">';
                                table_html += '<div class="col-6 card-table-header">注文日時</div>';
                                table_html += '<div class="col-6 card-table-data">' + return_formatted_datetime(active_order.fields.ordered_at) + '</div>';
                                table_html += '</div>';
                                table_html += '<div class="row">';
                                table_html += '<div class="col-6 card-table-header">ステータス</div>';
                                table_html += '<div class="col-6 card-table-data">' + STATUS[active_order.fields.status] + '</div></div><hr>';
                                table_html += '<div class="row">';
                                table_html += '<button pk="' + active_order.pk + '" type="button" class="btn btn-outline-secondary" name="cancel_order_button">CANCEL</button>';
                                table_html += '</div></div></div></div></div><hr>';
                            });
                            if (table_html == '') {
                                table_html = '<div class="row"><div class="col-6 offset-1">取引はありません</div></div>';
                            }
                            $('#active_orders_content').html(table_html);


                            //キャンセルボタンクリック時のイベント追加
                            $("button[name='cancel_order_button']").on('click', function() {
                                var pk = $(this).attr('pk');
                                call_cancel_order(pk)
                                .done(function(res) {
                                    if (res.error) {
                                        set_error_message('#id_ajax_message', res.error);
                                        return;
                                    }
                                
                                    set_success_message(message_target, '注文をキャンセルしました');
                                    $('#active_orders_button').click();
                                    message_target.show();
                                })
                                .fail(function(data, textStatus, xhr) {
                                    if (data.status == 401) {
                                        window.location.href = "{% url 'bitbank:login' %}";
                                    }
                                    set_error_message(message_target, xhr);
                                });
                                
                            });
                        })
                        .fail(function(data, textStatus, xhr) {
                            if (data.status == 401) {
                                window.location.href = "{% url 'bitbank:login' %}";
                            }
                            set_error_message(message_target, xhr);
                        });
                    }
                });
            })
            .fail(function(data, textStatus, xhr) {
                if (data.status == 401) {
                    window.location.href = "{% url 'bitbank:login' %}";
                }
                set_error_message(message_target, xhr);
            });
        }
        function initialize_active_orders_tab(is_initial = false) {
            var message_target = $('#id_ajax_message');
            var search_pair = $('#id_active_orders_search_pair');
            
            if (is_initial) {
                var search_pair_option_html = '';
                search_pair_option_html += '<option value="all">全て</option>'; 
                Object.keys(PAIRS).forEach(pair => {
                    search_pair_option_html += '<option value="' + pair + '">' + PAIRS[pair] + '</option>';
                });
                search_pair.html(search_pair_option_html);

                search_pair.on('change', function() {
                    $.cookie(COOKIE_SEARCH_PAIR_ACTIVE_ORDERS, $(this).val(), {expire: 7});
                    initialize_active_orders_content(message_target);
                });
            }
            var ck_search_pair_ao = $.cookie(COOKIE_SEARCH_PAIR_ACTIVE_ORDERS);
            if (ck_search_pair_ao != undefined) {
                search_pair.val(ck_search_pair_ao).trigger('change');
            } else {
                search_pair.val('all').trigger('change');
            }
        }
        function initialize_order_history_content(message_target) {
            var page_selection = $('#page_selection_order_history');
            var search_pair = $('#id_order_history_search_pair').val();

            call_get_order_history(0, 1, search_pair)
            .done(function(res_1) {
                if (res_1.error) {
                    set_error_message(message_target, res_1.error);
                    return;
                }
                if(page_selection.data("twbs-pagination")){
                    page_selection.empty();
                    page_selection.removeData("twbs-pagination");
                    page_selection.unbind("page");
                } 
                page_selection.twbsPagination({
                    totalPages: (res_1.total_count == 0) ? 1 : Math.ceil(res_1.total_count / count_per_page),
                    next: '次',
                    prev: '前',
                    first: '先頭',
                    last: '最後',
                    onPageClick: function (event, page) {
                        var table_html = '';
                        call_get_order_history(count_per_page * (page - 1), count_per_page, search_pair)
                        .done(function(res_2) {
                            if (res_2.error) {
                                set_error_message(message_target, res_2.error);
                                return;
                            }
                            $.parseJSON(res_2.order_history).forEach(order => {
                                table_html += '<div class="row"><div class="col-md-6 offset-md-1 col-12"><div class="card order-card"><div class="card-body"><div class="row">';
                                table_html += '<div class="col-3 card-table-header">注文ID</div>';
                                table_html += '<div class="col-3 card-table-data">' + order.fields.order_id + '</div>';
                                table_html += '<div class="col-3 card-table-header">取引通貨</div>';
                                table_html += '<div class="col-3 card-table-data">' + PAIRS[order.fields.pair] + '</div>';
                                table_html += '</div>';
                                table_html += '<div class="row">';
                                table_html += '<div class="col-2 card-table-header">タイプ</div>';
                                table_html += '<div class="col-4 card-table-data">' + ORDER_TYPES[order.fields.order_type] + '</div>';
                                table_html += '<div class="col-3 card-table-header">売/買</div>';
                                table_html += '<div class="col-3 card-table-data">' + SELL_BUY[order.fields.side] + '</div>';
                                table_html += '</div>';
                                table_html += '<div class="row">';
                                table_html += '<div class="col-3 card-table-header">数量</div>';
                                table_html += '<div class="col-3 card-table-data">' + order.fields.start_amount + '</div>';
                                table_html += '<div class="col-3 card-table-header">価格</div>';
                                table_html += '<div class="col-3 card-table-data">' + hyphen_if_null(order.fields.price) + '</div>';
                                table_html += '</div>';
                                table_html += '<div class="row">';
                                table_html += '<div class="col-3 card-table-header">約定数量</div>';
                                table_html += '<div class="col-3 card-table-data">' + hyphen_if_null(order.fields.executed_amount) + '</div>';
                                table_html += '<div class="col-3 card-table-header">平均価格</div>';
                                table_html += '<div class="col-3 card-table-data">' + hyphen_if_null(order.fields.average_price) + '</div>';
                                table_html += '</div>';
                                table_html += '<div class="row">';
                                table_html += '<div class="col-6 card-table-header">注文日時</div>';
                                table_html += '<div class="col-6 card-table-data">' + return_formatted_datetime(order.fields.ordered_at) + '</div>';
                                table_html += '</div>';
                                table_html += '<div class="row">';
                                table_html += '<div class="col-6 card-table-header">ステータス</div>';
                                table_html += '<div class="col-6 card-table-data">' + STATUS[order.fields.status] + '</div>';
                                table_html += '</div></div></div></div></div><hr>';
                            });
                            // 1件もない場合
                            if (table_html == '') {
                                table_html = '<div class="row"><div class="col-6 offset-1">取引はありません</div></div>';
                            }
                            $('#order_history_content').html(table_html);
                        })
                        .fail(function(data, textStatus, xhr) {
                            if (data.status == 401) {
                                window.location.href = "{% url 'bitbank:login' %}";
                            }
                            set_error_message(message_target, xhr);
                        });
                    }
                });
            })
            .fail(function(data, textStatus, xhr) {
                if (data.status == 401) {
                    window.location.href = "{% url 'bitbank:login' %}";
                }
                set_error_message(message_target, xhr);
            });
        }
        function initialize_order_history_tab(is_initial = false) {
            var message_target = $('#id_ajax_message');
            var search_pair = $('#id_order_history_search_pair');
            
            if (is_initial) {
                var search_pair_option_html = '';
                search_pair_option_html += '<option value="all">全て</option>'; 
                Object.keys(PAIRS).forEach(pair => {
                    search_pair_option_html += '<option value="' + pair + '">' + PAIRS[pair] + '</option>';
                });
                search_pair.html(search_pair_option_html);

                search_pair.on('change', function() {
                    $.cookie(COOKIE_SEARCH_PAIR_ORDER_HISTORY, $(this).val(), {expire: 7});
                    initialize_order_history_content(message_target);
                });
            }
            
            var ck_search_pair_oh = $.cookie(COOKIE_SEARCH_PAIR_ORDER_HISTORY);
            if (ck_search_pair_oh != undefined) {
                search_pair.val(ck_search_pair_oh).trigger('change');
            } else {
                search_pair.val('all').trigger('change');
            }
        }
        
        function initialize_alerts_content(message_target) {
            call_get_notify_if_filled()
            .done(function(res) {
                if (res.error) {
                    set_error_message(message_target, res.error);
                    return;
                }
                if (res.notify_if_filled == 'ON') {
                    $('#notify_if_filled_on_button').click();
                } else {
                    $('#notify_if_filled_off_button').click();
                }
            })
            .fail(function(data, textStatus, xhr) {
                if (data.status == 401) {
                    window.location.href = "{% url 'bitbank:login' %}";
                }
                set_error_message(message_target, xhr);
            });

            var page_selection = $('#page_selection_alerts');
            var search_pair = $('#id_alerts_search_pair').val();
            call_get_active_alerts(0, 1, search_pair)
            .done(function(res_1) {
                if (res_1.error) {
                    set_error_message(message_target, res_1.error);
                    return;
                }
                if(page_selection.data("twbs-pagination")){
                    page_selection.empty();
                    page_selection.removeData("twbs-pagination");
                    page_selection.unbind("page");
                }
                page_selection.twbsPagination({
                    totalPages: (res_1.total_count == 0) ? 1 : Math.ceil(res_1.total_count / count_per_page),
                    next: '次',
                    prev: '前',
                    first: '先頭',
                    last: '最後',
                    onPageClick: function (event, page) {
                        var table_html = '';
                        call_get_active_alerts(count_per_page * (page - 1), count_per_page, search_pair)
                        .done(function(res_2) {
                            var table_html = '';
                            $.parseJSON(res_2.active_alerts).forEach(active_alert => {
                                table_html += '<div class="row"><div class="col-md-6 offset-md-1 col-12"><div class="card order-card"><div class="card-body"><div class="row">';
                                table_html += '<div class="col-6 card-table-header">取引通貨</div>';
                                table_html += '<div class="col-6 card-table-data">' + PAIRS[active_alert.fields.pair] + '</div>';
                                table_html += '</div>';
                                table_html += '<div class="row">';
                                table_html += '<div class="col-6 card-table-header">通知レート</div>';
                                table_html += '<div class="col-6 card-table-data">' + active_alert.fields.threshold + '</div>';
                                table_html += '</div>';
                                table_html += '<div class="row">';
                                table_html += '<button pk="' + active_alert.pk + '" type="button" class="btn btn-outline-secondary" name="deactivate_alert_button">CANCEL</button>';
                                table_html += '</div>'
                                table_html += '</div></div></div></div><hr>';
                            });
                            $('#alert_container').html(table_html);
                        
                            $("button[name='deactivate_alert_button']").on('click', function() {
                                var pk = $(this).attr('pk');
                                call_deactivate_alert(pk)
                                .done(function(res_3) {
                                    if (res_3.error) {
                                        set_error_message(message_target, res_3.error);
                                        return;
                                    }
                                    set_success_message('#id_ajax_message', '通知設定を解除しました');
                                    
                                    $('#alerts_button').click();
                                    message_target.show();
                                })
                                .fail(function(data, textStatus, xhr) {
                                    if (data.status == 401) {
                                        window.location.href = "{% url 'bitbank:login' %}";
                                    }
                                    set_error_message(message_target, xhr);
                                });
                            });
                        })
                        .fail(function(data, textStatus, xhr) {
                            if (data.status == 401) {
                                window.location.href = "{% url 'bitbank:login' %}";
                            }
                            set_error_message(message_target, xhr);
                        });
                    }
                });
        
            })
            .fail(function(data, textStatus, xhr) {
                if (data.status == 401) {
                    window.location.href = "{% url 'bitbank:login' %}";
                }
                set_error_message(message_target, xhr);
            });
        }
        function initialize_alerts_tab(is_initial = false) {
            var message_target = $('#id_ajax_message');
            // 初回時のみの処理
            if (is_initial) {
                var option_html = '';
                Object.keys(PAIRS).forEach(pair => {
                    option_html += '<option value="' + pair + '">' + PAIRS[pair] + '</option>';
                });
                
                $('#id_pair_for_alert').on('change', function() {
                    $.cookie(COOKIE_ALERT_PAIR, $(this).val(), {expire: 7});
                    var currency = $(this).val().split('_')[1].toUpperCase();
                    $('#id_notice_rate').val('');
                    $('.pair_for_alert').html(currency);
                });
                $('#notify_if_filled_on_button').on('click', function() {
                    if ($(this).hasClass('on')) {
                        // すでにONの場合は何もしない
                    } else {
                        call_change_notify_if_filled('ON')
                        .done(function(res) {
                            if (res.error) {
                                set_error_message(message_target, res.error);
                                return;
                            }
                            $('#notify_if_filled_on_button').addClass('on').removeClass('btn-base');
                            $('#notify_if_filled_off_button').removeClass('off').addClass('btn-base');
                        })
                        .fail(function(data, textStatus, xhr) {
                            if (data.status == 401) {
                                window.location.href = "{% url 'bitbank:login' %}";
                            }
                            set_error_message(message_target, xhr);
                        });
                    }
                });
                $('#notify_if_filled_off_button').on('click', function() {
                    if ($(this).hasClass('off')) {
                        // すでにOFFの場合は何もしない
                    } else {
                        call_change_notify_if_filled('OFF')
                        .done(function(res) {
                            if (res.error) {
                                set_error_message(message_target, res.error);
                                return;
                            }
                            $('#notify_if_filled_on_button').removeClass('on').addClass('btn-base');
                            $('#notify_if_filled_off_button').addClass('off').removeClass('btn-base');
                        })
                        .fail(function(data, textStatus, xhr) {
                            if (data.status == 401) {
                                window.location.href = "{% url 'bitbank:login' %}";
                            }
                            set_error_message(message_target, xhr);
                        });
                    }
                });
                $('#add_alert_button').on('click', function() {
                    var threshold = $('#id_notice_rate').val();
                    var pair = $('#id_pair_for_alert').val();
                    var over_or_under;

                    if (threshold == '' || threshold == 0) {
                        set_error_message(message_target,'通知金額を入力して下さい');
                        return;
                    }

                    call_get_ticker_api(pair)
                    .done(function(res) {
                        if (res.error) {
                            set_error_message($('#id_ajax_messsage'), res.error)
                            return;
                        }
                        if (parseFloat(threshold) >= parseFloat(res.buy)) {
                            over_or_under = '以上';
                        } else {
                            over_or_under = '以下';
                        }
                        call_create_alert(pair, threshold, over_or_under)
                        .done(function(res) {
                            
                            if (res.error) {
                                set_error_message($('#id_ajax_messsage'), res.error)
                                return;
                            }
                            set_success_message(message_target, 'アラートを追加しました');

                            $('#alerts_button').click();
                            message_target.show();
                        })
                        .fail(function(data, textStatus, xhr) {
                            if (data.status == 401) {
                                window.location.href = "{% url 'bitbank:login' %}";
                            }
                            set_error_message(message_target, xhr);
                        });
                    });
                });
                
                $('#id_pair_for_alert').html(option_html);

                var search_pair_option_html = '';
                var search_pair = $('#id_alerts_search_pair')
                search_pair_option_html += '<option value="all">全て</option>'; 
                Object.keys(PAIRS).forEach(pair => {
                    search_pair_option_html += '<option value="' + pair + '">' + PAIRS[pair] + '</option>';
                });
                search_pair.html(search_pair_option_html);
                search_pair.on('change', function() {
                    $.cookie(COOKIE_SEARCH_PAIR_ALERTS, $(this).val(), {expire: 7});
                    initialize_alerts_content(message_target);
                });
            }
            var ck_alert_pair = $.cookie(COOKIE_ALERT_PAIR);
            if (ck_alert_pair != undefined && Object.keys(PAIRS).indexOf(ck_alert_pair) >= 0) {
                $('#id_pair_for_alert').val(ck_alert_pair).trigger('change');
            } else {
                $('#id_pair_for_alert').val(Object.keys(PAIRS)[0]).trigger('change');
            }
            var ck_search_pair_alerts = $.cookie(COOKIE_SEARCH_PAIR_ALERTS);
            if (ck_search_pair_alerts != undefined) {
                $('#id_alerts_search_pair').val(ck_search_pair_alerts).trigger('change');
            } else {
                $('#id_alerts_search_pair').val('all').trigger('change');
            }
        }
        function initialize_asset_tab(is_initial = false) {
            var message_target = $('#id_ajax_message');
            call_get_assets_api()
            .done(response => {
                if (response.assets) {
                    var asset_html = "";
                    var total_asset_in_jpy = 0;
                    response.assets.forEach(asset => {
                        
                        $('#' + asset.asset).html(asset.onhand_amount);
                        if (asset.asset == 'ltc' || asset.asset == 'eth') {
                            call_get_ticker_api(asset.asset + '_' + 'btc')
                            .done(function(res) {
                                if (res.error) {
                                    set_error_message(message_target, res.error);
                                    return;
                                }
                                call_get_ticker_api('btc_jpy')
                                .done(function(res2) {
                                    total_asset_in_jpy += parseInt(res.buy) * parseInt(res2.buy) * asset.onhand_amount;
                                    $('#total_in_jpy').html(parseInt(total_asset_in_jpy));
                                })
                                .fail(function(data, textStatus, xhr) {
                                    if (data.status == 401) {
                                        window.location.href = "{% url 'bitbank:login' %}";
                                    }
                                    set_error_message(message_target, xhr);
                                });
                            })
                            .fail(function(data, textStatus, xhr) {
                                if (data.status == 401) {
                                    window.location.href = "{% url 'bitbank:login' %}";
                                }
                                set_error_message(message_target, xhr);
                            });
                        } else if (asset.asset != 'jpy') {
                            call_get_ticker_api(asset.asset + '_jpy')
                            .done(function(res) {
                                if (res.error) {
                                    set_error_message(message_target, res.error);
                                    return;
                                }
                                total_asset_in_jpy += parseInt(res.buy * asset.onhand_amount);
                                $('#total_in_jpy').html(parseInt(total_asset_in_jpy));
                            })
                            .fail(function(data, textStatus, xhr) {
                                if (data.status == 401) {
                                    window.location.href = "{% url 'bitbank:login' %}";
                                }
                                set_error_message(message_target, xhr);
                            });
                        } else {
                            total_asset_in_jpy += parseInt(asset.onhand_amount);
                            $('#total_in_jpy').html(parseInt(total_asset_in_jpy));
                        }
                    });
                    //$("#asset_table").html(asset_html);
                } else {
                    if (response.error) {
                        set_error_message(message_target, response.error);
                    }
                }
            })
            .fail(function(data, textStatus, xhr) {
                if (data.status == 401) {
                    window.location.href = "{% url 'bitbank:login' %}";
                }
                set_error_message(message_target, xhr);
            });
        }
        function initialize_user_info_tab(is_initial = false) {
            var message_target = $('#id_ajax_message');
            call_get_user()
            .done(function(res) {
                if (res.error) {
                    set_error_message(message_target, res.error);
                    return;
                }
                var user_json = $.parseJSON(res.user)[0];
                $('#id_date_joined').html(return_formatted_datetime(Date.parse(user_json.fields.date_joined), true));
                $('#id_email').html(user_json.fields.email);
                $('#id_full_name').val(user_json.fields.full_name);
                $('#id_api_key').val(user_json.fields.api_key);
                $('#id_api_secret_key').val(user_json.fields.api_secret_key);
                $('#id_email_for_notice').val(user_json.fields.email_for_notice);
            })
            .fail(function(data, textStatus, xhr) {
                if (data.status == 401) {
                    window.location.href = "{% url 'bitbank:login' %}";
                }
                set_error_message(message_target, xhr);
            });
            // 初期ロード時のみ
            if (is_initial) {
                $('#id_update_user_info_button').on('click', function() {
                    var full_name = $('#id_full_name').val();
                    var api_key = $('#id_api_key').val();
                    var api_secret_key = $('#id_api_secret_key').val();
                    var email_for_notice = $('#id_email_for_notice').val();

                    if(!email_for_notice.match(/^([a-zA-Z0-9])+([a-zA-Z0-9\._-])*@([a-zA-Z0-9_-])+([a-zA-Z0-9\._-]+)+$/)){
                        // 不正なメールアドレスの場合
                        set_error_message(message_target, 'メールアドレスの形式が不正です');
                        $('#id_email_for_notice').focus();
                        return;
                    }

                    call_update_user(full_name, api_key, api_secret_key, email_for_notice)
                    .done(function(res) {
                        if (res.error) {
                            set_error_message(message_target, res.error);
                            return;
                        }
                        set_success_message(message_target, '登録情報を更新しました');
                        return;
                    })
                    .fail(function(data, textStatus, xhr) {
                        if (data.status == 401) {
                            window.location.href = "{% url 'bitbank:login' %}";
                        }
                        set_error_message(message_target, xhr);
                    });
                });
            }
        }
        
        function validate_contact_info(message_target) {
            //validations....
            var name = $('#id_contact_name');
            var email = $('#id_contact_email');
            var subject = $('#id_contact_subject');
            var body = $('#id_contact_body');
            
            if (name.val() == '') {
                set_error_message(message_target, '名前を入力してください');
                name.focus();
                return false;
            }
            if (email.val() == '') {
                set_error_message(message_target, '通知用メールアドレスを入力してください');
                email.focus();
                return false;
            }
            if (subject.val() == '') {
                set_error_message(message_target, '件名を入力してください');
                subject.focus();
                return false;
            }
            if (body.val() == '') {
                set_error_message(message_target, '内容を入力してください');
                body.focus();
                return false;
            }
            return true;
        }
        function initialize_contact_tab(is_initial = false) {
            var message_target = $('#id_contact_message');
            call_get_user()
            .done(function(res) {
                if (res.error) {
                    set_error_message(message_target, res.error);
                    return;
                }
                var user_json = $.parseJSON(res.user)[0];
                $('#id_contact_date').val(return_formatted_datetime((new Date()).getTime(), false));
                $('#id_contact_email').val(user_json.fields.email_for_notice);
                $('#id_contact_name').val(user_json.fields.full_name);
            })
            .fail(function(data, textStatus, xhr) {
                if (data.status == 401) {
                    window.location.href = "{% url 'bitbank:login' %}";
                }
                set_error_message(message_target, xhr);
            });
            // 初期ロード時のみ
            if (is_initial) {
                $('#id_contact_send_inquiry_button')
                .on('click', function() {
                    if (validate_contact_info(message_target)) {
                        call_post_inquiry_without_files($('#id_contact_subject').val(), $('#id_contact_body').val(), $('#id_contact_email').val())
                        .done(function(res) {
                            if (res.error) {
                                set_error_message(message_target, res.error);
                                return;
                            }
                            set_success_message(message_target, res.success);
                            return;
                        })
                        .fail(function(data, textStatus, xhr) {
                            if (data.status == 401) {
                                window.location.href = "{% url 'bitbank:login' %}";
                            }
                            set_error_message(message_target, xhr);
                        });
                    }
                });
                $(".js-upload-file").click(function () {
                    $("#fileupload").click();
                });

                /* 2. INITIALIZE THE FILE UPLOAD COMPONENT */
                $("#fileupload").fileupload({
                    dataType: 'json',
                    // limitMultiFileUploads: 3,
                    singleFileUploads: false,
                    add: function (e, data) { 
                        $('#id_contact_send_inquiry_button')
                        .unbind('click')
                        .on('click', function() {
                            if (validate_contact_info(message_target)) {
                                data.formData = {subject: $('#id_contact_subject').val(), body: $('#id_contact_body').val(), email_for_reply: $('#id_contact_email').val()};
                                data.submit();
                            } else {
                                return false;
                            }
                        });
                        if(data.files.length >= 4){
                            $(data).val('');
                            set_error_message(message_target, "添付ファイルは3つまでです");
                            return false;
                        }
                        var target = $('#id_attachment_preview');
                        target.html('');
                        for(let i = 0; i < data.files.length; i++) {
                            var prev_wrapper = document.createElement('div');
                            var prev = document.createElement('img');
                            var prev_caption = document.createElement('label');
                            $(prev_wrapper).addClass('attachment_preview');
                            $(prev).attr('id', 'file_' + i);
                            $(prev_caption).attr('for', 'file_' + i);
                            $(prev_caption).html(data.files[i].name);
                            readURL(data.files[i], prev);
                            prev_wrapper.append(prev);
                            prev_wrapper.append(prev_caption);
                            target.append(prev_wrapper);
                        }

                    },
                    done: function (e, data) {  /* 3. PROCESS THE RESPONSE FROM THE SERVER */
                       if (data.result.error) {
                           set_error_message(message_target, data.result.error);
                           return;
                       }
                       set_success_message(message_target, data.result.success);
                       return;
                    },
                    fail: function (e, data) {
                        set_error_message(message_target, '失敗しました');
                        return;
                    }
                });
            }
        }
        function readURL(file, target_img) {
            if (file) {
                var reader = new FileReader();

                reader.onload = function (e) {
                    $(target_img).attr('src', e.target.result);
                };

                reader.readAsDataURL(file);
            }
        }
        function set_error_message(target, message="ログインし直してください") {

            $(target).addClass('alert-danger');
            $(target).removeClass('alert-success');
            $(target).html(message);
            $(target).show();
            setTimeout(function() {
                $(target).fadeOut();
            }, 2000);
        }

        function set_success_message(target, message="正常に処理しました") {
            $(target).addClass('alert-danger');
            $(target).removeClass('alert-success');
            $(target).html('<i class="fa fa-check" aria-hidden="true"></i>' + message);
            $(target).show();
            setTimeout(function() {
                $(target).fadeOut();
            }, 2000);
        }

        function openTab(evt, tab_id) {

            $('#id_ajax_message').hide();
            $('#id_order_result_message').hide();
            $('#id_contact_message').hide();
            $.cookie(COOKIE_LAST_VISITED_TAB, tab_id, {expire: 7});
            switch( tab_id ) {
                case 'order':
                    initialize_order_tab(false);
                    break;
                case 'active_orders':
                    initialize_active_orders_tab(false);
                    break;
                case 'order_history':
                    initialize_order_history_tab(false);
                    break;
                case 'alerts':
                    initialize_alerts_tab(false);
                    break;
                case 'assets':
                    initialize_asset_tab(false);
                    break;
                case 'user_info':
                    initialize_user_info_tab(false);
                    break;
                case 'contact':
                    initialize_contact_tab(false);
                    break;
            }

            // Get all elements with class="tabcontent" and hide them
            $('.tabcontent').each((i, tabcontent) => {
                $(tabcontent).hide();
            });
        

            // Get all elements with class="tablinks" and remove the class "active"
            $('.tablinks').each((i, tablink) => {
                $(tablink).removeClass('active');
            });

            // Show the current tab, and add an "active" class to the button that opened the tab
            $('#' + tab_id).show();
            evt.target.className += " active";
        }
       



        $(function() {
            initialize_order_tab(true);
            initialize_active_orders_tab(true);
            initialize_order_history_tab(true);
            initialize_alerts_tab(true);
            initialize_asset_tab(true);
            initialize_user_info_tab(true);
            initialize_contact_tab(true);
            $('#order_button').click();
        });
        
    </script>
{% endblock %}
