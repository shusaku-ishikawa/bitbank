{% extends "bitbank/base.html" %}
{% block content %}
<form action="" method="POST">

    <div class="container">
        <div class="row">
            <div class="col-5">
                <div class="input-group xs-3">
                    <div class="input-group-prepend">
                        <span class="my_placeholder">通貨</span>
                    </div>
                    {{form.pair}}
                </div>
                <hr>
                <div class="input-group xs-3">
                    <div class="input-group-prepend">
                        <span class="my_placeholder">特殊注文</span>
                    </div>
                    {{form.special_order}}
                </div>
                
            </div>
            <div class="col-5">
                <table id="asset_table" class="table table-striped table-responsive">
                    <thead>
                        <tr>
                            <th>通貨</th>
                            <th>On hand</th>
                            <th>Locked</th>
                            <th>Free</th>
                        </tr>
                    </thead>
                    <tbody>

                    </tbody>
                </table>
            </div>
        </div>
        <hr>
        <div class="row">
            <div class="col-5">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="my_placeholder">売買</span>
                    </div>
                    {{form.side}}
                </div>
                <hr>
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="my_placeholder">注文方法</span>
                    </div>
                    {{form.order_type}}
                </div>
                <hr>
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="my_placeholder">注文価格</span>
                    </div>
                    {{form.price}}
                    <div class="input-group-append">
                        <span class="my_placeholder">円</span>
                    </div>
                </div>
                <hr>            
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="my_placeholder">逆指値の指値価格</span>
                    </div>
                    {{form.limit_price}}
                    <div class="input-group-append">
                        <span class="my_placeholder">円</span>
                    </div>
                </div>
                <hr>
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="my_placeholder">注文数量</span>
                    </div>
                    {{form.start_amount}}
                    <div class="input-group-append">
                        <span class="my_placeholder"></span>
                    </div>
                </div>               
            </div>
            <div class="col-5">
                <div class="input-group">
                    約定通知
                    {{form.notify_if_filled}}
                </div>
                <hr>
                <div class="input-group">
                    金額到達通知
                    {{form.notify_if_reach}}
                </div>
                <hr>
                <div class="input-group">
                    <div class="input-group-prepend">
                       <span class="my_placeholder">①価格到達通知設定</span> 
                    </div>
                    {{form.price_threshold_1}}
                    <div class="input-group-append">
                        <span class="my_placeholder">円</span>
                    </div>
                </div>
                <hr>            
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="my_placeholder">②価格到達通知設定</span>
                    </div>
                    {{form.price_threshold_2}}
                    <div class="input-group-append">
                        <span class="my_placeholder">円</span>
                    </div>
                </div>
                <hr>
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="my_placeholder">③価格到達通知設定</span>
                    </div>
                    {{form.price_threshold_3}}
                    <div class="input-group-append">
                        <span class="my_placeholder">円</span>
                    </div>
                </div>
                <hr>            
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="my_placeholder">④価格到達通知設定</span>
                    </div>
                    {{form.price_threshold_4}}
                    <div class="input-group-append">
                        <span class="my_placeholder">円</span>
                    </div>
                </div>
                <hr>
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="my_placeholder">⑤価格到達通知設定</span>
                    </div>
                    {{form.price_threshold_5}}
                    <div class="input-group-append">
                        <span class="my_placeholder">円</span>
                    </div>
                </div>
            </div>
                
        </div>
    </div>             

</form>
{% endblock %}
{% block extra_js %}
    <script>
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        var csrftoken = getCookie('csrftoken');

        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }

        $.ajaxSetup({
            beforeSend: function (xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });

        // load時に資産一覧取得
        $(function() {
            $.ajax({
                'url': '{% url "bitbank:ajax_get_assets" %}',
                'type': 'GET',
                'dataType': 'json'
            }).done( response => {
                if (response.assets) {
                    var asset_html = "";
                    response.assets.forEach(asset => {
                        asset_html += '<tr>';
                        asset_html += '<td>' + asset.asset + '</td>';
                        asset_html += '<td>' + asset.onhand_amount + '</td>';
                        asset_html += '<td>' + asset.locked_amount + '</td>';
                        asset_html += '<td>' + asset.free_amount + '</td>';
                        asset_html += '</tr>';
                    });
                    $("#asset_table > tbody").html(asset_html);
                } else {
                    alert('資産情報の取得に失敗しました。')
                }
            });
        })
    </script>
{% endblock %}