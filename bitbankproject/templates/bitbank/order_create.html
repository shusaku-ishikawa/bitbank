{% extends "bitbank/base.html" %}
{% block content %}
<form action="" method="POST">
        
    {% csrf_token %}

     <div class="container">
        <div class="row">
            {{ form.non_field_errors }}
            <div class="col-5">
                <div class="input-group xs-3">
                    <div class="input-group-prepend">
                        <span class="my_placeholder">通貨</span>
                    </div>
                    {{form.pair}}
                    {{ form.pair.errors }}
                </div>
                <hr>
                <div class="input-group xs-3">
                    <div class="input-group-prepend">
                        <span class="my_placeholder">特殊注文</span>
                    </div>
                    {{form.special_order}}
                    {{ form.special_order.errors }}
                </div>
                
            </div>
            <div class="col-5">
                <table id="asset_table" class="table table-striped table-responsive">
                    <thead>
                        <tr>
                            <th>通貨</th>
                            <th>On hand</th>
                            <th>Locked</th>
                            <th>Free</th>
                        </tr>
                    </thead>
                    <tbody>

                    </tbody>
                </table>
            </div>
        </div>
        <hr>
        <div class="row">
            <div class="col-5">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="my_placeholder">売買</span>
                    </div>
                    {{form.side}}
                    {{ form.side.errors }}
                </div>
                <hr>
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="my_placeholder">注文方法</span>
                    </div>
                    {{form.order_type}}
                    {{ form.order_type.errors }}
                </div>
                <hr>
                <div style="display: none" class="input-group show_if_limit">
                    <div class="input-group-prepend">
                        <span class="my_placeholder">注文価格</span>
                    </div>
                    {{form.price}}
                    {{form.price.errors}}                    
                    <div class="input-group-append">
                        <span class="my_placeholder">円</span>
                    </div>
                </div>
                <hr>            
                <div style="display:none" class="input-group show_if_reverse_limit">
                    <div class="input-group-prepend">
                        <span class="my_placeholder">逆指値の指値価格</span>
                    </div>
                    {{form.limit_price}}
                    {{form.limit_price.errors}}
                    <div class="input-group-append">
                        <span class="my_placeholder">円</span>
                    </div>
                </div>
                <hr>
                <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="my_placeholder">予想</span>
                        </div>
                        {{form.expect_price}}
                        {{form.expect_price.errors}}
                        <div class="input-group-append">
                            <span class="my_placeholder">円</span>
                        </div>
                    </div>
                <hr>
                    
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="my_placeholder">注文数量</span>
                    </div>
                    {{form.start_amount}}
                    {{form.start_amount.errors}}
                    <div class="input-group-append">
                        <span class="my_placeholder"></span>
                    </div>
                </div>
                <hr>
                <div class="input-group">
                    <button id="id_order_button" type="submit" class="btn btn-lg btn-block green_button">注文</button>
                </div>
                            
            </div>
            <div class="col-5">
                <div class="input-group">
                    約定通知
                    {{form.notify_if_filled}}
                    {{form.notify_if_filled.errors}}
                    
                </div>
                <hr>
                <div class="input-group">
                    金額到達通知
                    {{form.notify_if_reach}}
                    {{form.notify_if_reach.errors}}
                    
                </div>
                <hr>
                <div class="input-group">
                    <div class="input-group-prepend">
                       <span class="my_placeholder">①価格到達通知設定</span> 
                    </div>
                    {{form.price_threshold_1}}
                    {{form.price_threshold_1.errors}}
                    
                    <div class="input-group-append">
                        <span class="my_placeholder">円</span>
                    </div>
                </div>
                <hr>            
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="my_placeholder">②価格到達通知設定</span>
                    </div>
                    {{form.price_threshold_2}}
                    {{form.price_threshold_2.errors}}
                    <div class="input-group-append">
                        <span class="my_placeholder">円</span>
                    </div>
                </div>
                <hr>
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="my_placeholder">③価格到達通知設定</span>
                    </div>
                    {{form.price_threshold_3}}
                    {{form.price_threshold_3.errors}}
                    <div class="input-group-append">
                        <span class="my_placeholder">円</span>
                    </div>
                </div>
                <hr>            
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="my_placeholder">④価格到達通知設定</span>
                    </div>
                    {{form.price_threshold_4}}
                    {{form.price_threshold_4.errors}}
                    <div class="input-group-append">
                        <span class="my_placeholder">円</span>
                    </div>
                </div>
                <hr>
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="my_placeholder">⑤価格到達通知設定</span>
                    </div>
                    {{form.price_threshold_5}}
                    {{form.price_threshold_5.errors}}
                    <div class="input-group-append">
                        <span class="my_placeholder">円</span>
                    </div>
                </div>
            </div>
                
        </div>
    </div>              
    
</form>
{% endblock %}
{% block extra_js %}
    <script>
            function getCookie(name) {
                var cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    var cookies = document.cookie.split(';');
                    for (var i = 0; i < cookies.length; i++) {
                        var cookie = jQuery.trim(cookies[i]);
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            var csrftoken = getCookie('csrftoken');

            function csrfSafeMethod(method) {
                // these HTTP methods do not require CSRF protection
                return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
            }

            $.ajaxSetup({
                beforeSend: function (xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                }
            });

        $(function() {
            //逆指値の時のみ
            $('#id_order_type').on('change', function() {
                if ($(this).val() == '逆指値') {
                    $('.show_if_reverse_limit').show();
                } else {
                    $('.show_if_reverse_limit').hide();
                }
                if ($(this).val() == '指値') {
                    $('.show_if_limit').show();
                } else {
                    $('.show_if_limit').hide();
                }
                
            });

            $.ajax({
                'url': '{% url "bitbank:ajax_get_assets" %}',
                'type': 'GET',
                'dataType': 'json'
            }).done( response => {
                if (response.assets) {
                    var asset_html = "";
                    response.assets.forEach(asset => {
                        asset_html += '<tr>';
                        asset_html += '<td>' + asset.asset + '</td>';
                        asset_html += '<td>' + asset.onhand_amount + '</td>';
                        asset_html += '<td>' + asset.locked_amount + '</td>';
                        asset_html += '<td>' + asset.free_amount + '</td>';
                        asset_html += '</tr>';
                    });
                    $("#asset_table > tbody").html(asset_html);
                } else {
                    alert('資産情報の取得に失敗しました。')
                }
            });
        });
    </script>
{% endblock %}